---
title: 自定义漏洞保护
keywords: Exploit Protection， 缓解， 启用， powershell， dep， cfg， emet， aslr
description: 可以使用应用或 PowerShell 启用或禁用 exploit Protection Windows 安全中心缓解。 还可以审核缓解和导出配置。
ms.prod: m365-security
ms.mktglfcycl: manage
ms.sitesec: library
ms.localizationpriority: medium
audience: ITPro
ms.topic: conceptual
author: dansimp
ms.author: dansimp
ms.reviewer: ''
manager: dansimp
ms.technology: mde
ms.collection: m365-security-compliance
ms.date: ''
ms.openlocfilehash: b52238069a69a08921fec79c67ab979bd7668bb7
ms.sourcegitcommit: bdd6ffc6ebe4e6cb212ab22793d9513dae6d798c
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/08/2022
ms.locfileid: "63322739"
---
# <a name="customize-exploit-protection"></a>自定义漏洞保护

[!INCLUDE [Microsoft 365 Defender rebranding](../../includes/microsoft-defender.md)]


**适用于：**
- [Microsoft Defender for Endpoint 计划 1](https://go.microsoft.com/fwlink/p/?linkid=2154037)
- [Microsoft Defender for Endpoint 计划 2](https://go.microsoft.com/fwlink/p/?linkid=2154037)
- [Microsoft 365 Defender](https://go.microsoft.com/fwlink/?linkid=2118804)

> 想要体验适用于终结点的 Defender？ [注册免费试用版](https://signup.microsoft.com/create-account/signup?products=7f379fee-c4f9-4278-b0a1-e4c8c2fcdf7e&ru=https://aka.ms/MDEp2OpenTrial?ocid=docs-wdatp-assignaccess-abovefoldlink)。

Exploit Protection 会自动在操作系统进程和个别应用上应用大量攻击缓解技术。

在单个设备上使用Windows 安全中心应用配置这些设置。 然后，将配置导出为 XML 文件，以便你可以部署到其他设备。 使用组策略将 XML 文件一次分发到多个设备。 您还可以使用 PowerShell 配置缓解。

本文列出了 Exploit Protection 中可用的每个缓解。 它指示是否可以将缓解应用于系统范围或个别应用，并简要说明缓解的工作原理。

它还介绍了如何使用 Windows 安全中心、PowerShell 和移动设备管理 (MDM) 配置服务提供程序 (缓解) 。 这是创建可跨网络部署的配置的第一步。 下一步 [涉及生成、导出、导入配置以及将配置部署到多台设备](import-export-exploit-protection-emet-xml.md)。

> [!WARNING]
> 某些安全缓解技术可能与某些应用程序存在兼容性问题。在跨生产环境或网络的其余部分部署配置之前，应通过使用 [审核模式](evaluate-exploit-protection.md) 在所有目标使用方案中测试攻击保护。

## <a name="exploit-protection-mitigations"></a>Exploit Protection 缓解

可以针对个别应用配置所有缓解。 某些缓解还可以在操作系统级别应用。

你可以将每个缓解设置为打开、关闭或设置为其默认值。 某些缓解具有表的说明中指示的其他选项。

默认值始终在"使用每个缓解的默认选项" **的** 括号中指定。 在下面的示例中，数据执行保护的默认值为"On"。

" **使用** 每个缓解设置的默认配置"指示我们针对家庭用户日常使用的基本保护级别的建议。 Enterprise部署应考虑其个人需求所需的保护，并且可能需要修改默认配置。

有关每个缓解的关联 PowerShell cmdlet，请参阅本文底部的 [PowerShell](#cmdlets-table) 参考表。

|缓解|说明|可应用于|审核模式可用|
|---|---|---|---|
|控制流保护 (CFG) |确保间接调用的控制流完整性。 可以选择禁止导出并使用严格的 CFG。|系统和应用级别|否|
|数据执行保护(DEP)|防止从仅数据内存页（如堆和堆栈）运行代码。 仅适用于 32 位 (x86) 应用，对所有其他体系结构永久启用。 可以选择启用 ATL thunk 模拟。|系统和应用级别|否|
|强制图像随机化(强制 ASLR)|强制重定位未使用 /DYNAMICBASE 编译的图像。 （可选）无法加载没有重定位信息的图像。|系统和应用级别|否|
|随机内存分配(由下而上 ASLR)|随机化虚拟内存分配的位置。 它包括系统结构堆、堆栈、TEB 和 PEB。 可以选择对 64 位进程使用更大的随机化差异。|系统和应用级别|否|
|验证异常链(SEHOP)|确保异常调度期间异常链的完整性。 仅可配置 32 位 (x86) 应用程序。|系统和应用级别|否|
|验证堆完整性|在检测到堆损坏时终止进程。|系统和应用级别|否|
|任意代码防护(ACG)|阻止引入非图像支持的可执行代码，并阻止修改代码页。 可以选择允许线程退出并允许远程降级 (PowerShell) 。|仅应用级别|是|
|阻止低完整性图像|阻止加载标记为低完整性的图像。|仅应用级别|是|
|阻止远程图像|阻止从远程设备加载图像。|仅应用级别|否|
|阻止不受信任的字体|阻止加载系统字体目录中未安装的任何基于 GDI 的字体，尤其是来自 Web 的字体。|仅应用级别|是|
|代码完整性防护|限制加载由 Microsoft、WHQL 或更高版本签名的图像。 可以选择允许Microsoft Store签名的图像。|仅应用级别|是|
|禁用扩展点|禁用允许 DLL 注入到所有进程（如 AppInit DLL、窗口挂钩和 Winsock 服务提供商）的各种扩展性机制。|仅应用级别|否|
|禁用 Win32k 系统调用|阻止应用使用 Win32k 系统调用表。|仅应用级别|是|
|不允许子进程|阻止应用创建子进程。|仅应用级别|是|
|导出地址筛选(EAF)|检测恶意代码正在解决危险操作。 可以选择验证攻击常用的模块的访问。|仅应用级别|是|
|导入地址筛选(IAF)|检测恶意代码正在解决危险操作。|仅应用级别|是|
|模拟执行(SimExec)|确保对敏感 API 的调用返回到合法的调用方。 仅可配置 32 位 (x86) 应用程序。 与 ACG 不兼容。|仅应用级别|是|
|验证 API 调用(CallerCheck)|确保合法调用方调用敏感 API。 仅可配置 32 位 (x86) 应用程序。 与 ACG 不兼容|仅应用级别|是|
|验证处理使用情况|导致在任何无效句柄引用上引发异常。|仅应用级别|否|
|验证映像依赖项完整性|强制对加载Windows进行代码签名。|仅应用级别|否|
|验证堆栈完整性(StackPivot)|确保堆栈尚未针对敏感 API 进行重定向。 与 ACG 不兼容。|仅应用级别|是|

> [!IMPORTANT]
> 如果你将应用添加到计划 **设置部分，** 并在那里配置个别缓解设置，则它们在"系统设置"部分中指定的相同缓解 **的配置上方会获得** 支持。 以下矩阵和示例可帮助说明默认设置如何工作：
>
>
> |在程序 **设置中启用**|在系统 **设置中启用**|行为|
> |---|---|---|
> |是|否|如程序 **设置中的定义**|
> |是|是|如程序 **设置中的定义**|
> |否|是|如系统 **设置中的定义**|
> |否|是|默认，如 **使用默认选项** 中定义|
>
>
> - **示例 1**
>
>    M一el 将"系统设置" **(DEP** **) 配置为"** 默认关闭 **"**。
>
>    然后，M一el 将应用 *test.exe* " **程序设置"** 部分。 在该应用的选项中，在"数据执行保护 (**DEP)**"下，他启用"覆盖系统设置"选项，将开关设置为 **"开"**。 "程序设置"部分未列出 **任何其他** 应用。
>
>    结果是仅对启用 DEP *的test.exe。* 所有其他应用将不会应用 DEP。
>
>
> - **示例 2**
>
>    Josie 在"系统设置" **(DEP** **) 配置为"** 默认关闭 **"**。
>
>    然后，Josie 将应用 *test.exe* 程序 **设置部分** 。 在该应用的选项中，在"数据执行保护 (**DEP)**，她启用"覆盖系统设置"选项，将开关设置为 **"开"**。
>
>    Josie 还将 *应用miles.exe添加到*"程序设置"部分，并将"控制流保护" (**CFG**) **"打开"**。 她未为 DEP 或该应用的其他任何缓解启用替代系统设置选项。
>
>    结果是将启用 DEP *以启用* test.exe。 不会为任何其他应用启用 DEP *，包括miles.exe*。 CFG *将启用miles.exe*。

> [!NOTE]
> 如果发现本文中的问题，可以直接将问题报告给 Windows Server/Windows 客户端合作伙伴或使用你国家/地区 Microsoft 技术支持号码。

### <a name="configure-system-level-mitigations-with-the-windows-security-app"></a>使用应用配置Windows 安全中心缓解

1. 通过在任务栏Windows 安全中心防护图标或搜索"开始"菜单来打开 **Windows 安全中心。**

2. 选择应用 **&浏览器控制** 磁贴 (或左侧菜单栏上的应用图标) 选择 Exploit **Protection**。

3. 在 **"系统设置** "部分下，找到你要配置的缓解并选择以下选项之一。 未在"程序设置"部分单独 **配置的应用将使用** 此处配置的设置：
   - **默认启用** - 为在特定于应用的程序设置部分中未设置此缓解的应用 **启用缓解**
   - **默认情况下关闭** - 对在特定于应用的程序设置部分中没有设置此缓解的应用 **禁用缓解**
   - **使用默认值** - 根据 Windows 10 或 Windows 11 安装设置的默认配置，启用或禁用缓解;默认值 (**On** 或 **Off**) 始终在"使用每个缓解的默认标签"旁边指定

   > [!NOTE]
   > 更改某些设置时，可能会看到"用户帐户控制"窗口。 输入管理员凭据以应用该设置。

   更改某些设置可能需要重新启动。

4. 对要配置的所有系统级缓解重复此操作。

5. 转到计划 **设置** 部分，然后选择你要应用缓解的应用：

   1. 如果已列出要配置的应用，请选择它，然后选择"编辑 **"**
   2. 如果未列出应用，请在列表顶部选择"添加程序"进行自定义，然后选择希望如何添加应用：
      - 使用 **"按程序名称** 添加"将缓解应用于具有该名称的任何正在运行的进程。 必须指定扩展名文件。 你可以输入完整路径，将缓解限制为仅该位置中具有该名称的应用。
      - Use **Choose exact file path** to use a standard Windows Explorer file picker window to find and select the file you want.

6. 选择应用后，你将看到可应用的所有缓解的列表。 若要启用缓解，请选中复选框，然后将滑块更改为 **"打开"**。 选择任何其他选项。 选择 **审核** 将仅在审核模式下应用缓解。 如果需要重新启动进程或应用，或者需要重新启动进程或应用，你将收到Windows。

7. 对要配置的所有应用和缓解重复这些步骤。 **完成配置** 设置后，选择"应用"。

你现在可以将 [这些设置导出为 XML 文件，](import-export-exploit-protection-emet-xml.md) 也可以继续配置特定于应用的缓解。

将配置导出为 XML 文件后，你可以将配置从一台设备复制到其他设备。

## <a name="powershell-reference"></a>PowerShell 参考

可以使用应用Windows 安全中心 Exploit Protection，或者使用 PowerShell cmdlet。

将始终应用最近修改的配置设置 -无论你是使用 PowerShell 还是 Windows 安全中心。 这意味着，如果你使用该应用配置缓解，然后使用 PowerShell 配置相同的缓解，应用将更新以显示你使用 PowerShell 所做的更改。 如果你随后使用该应用再次更改缓解，该更改将适用。

> [!IMPORTANT]
> 通过组策略部署到设备的任何更改都将覆盖本地配置。 设置初始配置时，请使用不会应用组策略配置的设备，以确保你的更改不会覆盖。

可以使用 PowerShell 动词或 `Get` `Set` cmdlet `ProcessMitigation`。 使用 `Get` 将列出设备上已启用的任何缓解的当前配置状态 - `-Name` 添加 cmdlet 和 app exe 以查看仅该应用的缓解：

```PowerShell
Get-ProcessMitigation -Name processName.exe
```

> [!IMPORTANT]
> 尚未配置的系统级别缓解将显示 状态 `NOTSET`。
>
> 对于系统级别的设置， `NOTSET` 指示已应用该缓解的默认设置。
>
> 对于应用级别的设置 `NOTSET` ，指示将应用缓解的系统级别设置。
>
> 每个系统级别缓解的默认设置都可以看到在Windows 安全中心。

使用以下 `Set` 格式配置每个缓解：

```PowerShell
Set-ProcessMitigation -<scope> <app executable> -<action> <mitigation or options>,<mitigation or options>,<mitigation or options>
```

其中：

- \<Scope\>:
  - `-Name` 指示缓解应应用于特定应用。 在此标志后指定应用的可执行文件。
  - `-System` 指示应在系统级别应用缓解
- \<Action\>:
  - `-Enable` 启用缓解
  - `-Disable` 禁用缓解
- \<Mitigation\>:
  - 缓解的 cmdlet，如下面的缓解 [cmdlet](#cmdlets-table) 表中定义，以及所有子选项 (空格) 。 每个缓解用逗号分隔。

例如，若要使用 ATLnk 仿真为数据执行保护 (DEP) 缓解，并为 *文件夹 C：\Apps\LOB\tests* 中名为 *testing.exe* 的可执行文件启用缓解，并阻止该可执行文件创建子进程，可使用以下命令：

```PowerShell
Set-ProcessMitigation -Name c:\apps\lob\tests\testing.exe -Enable DEP, EmulateAtlThunks, DisallowChildProcessCreation
```

> [!IMPORTANT]
> 使用逗号分隔每个缓解选项。

如果要在系统级别应用 DEP，请使用以下命令：

```PowerShell
Set-Processmitigation -System -Enable DEP
```

若要禁用缓解，你可以将 替换为 `-Enable` `-Disable`。 但是，对于应用级别的缓解，这将强制仅为该应用禁用缓解。

如果需要将缓解恢复为 `-Remove` 系统默认值，还需要包括 cmdlet，如以下示例所示：

```PowerShell
Set-Processmitigation -Name test.exe -Remove -Disable DEP
```

还可以将某些缓解设置为审核模式。 请使用以下缓解 cmdlet 表中指定的审核 **模式 cmdlet** ，而不是将 PowerShell [cmdlet 用于](#cmdlets-table) 缓解。

例如，若要在审核模式下为 (使用的) 启用任意代码防护和 ACGtesting.exe，请使用以下命令：**

```PowerShell
Set-ProcessMitigation -Name c:\apps\lob\tests\testing.exe -Enable AuditDynamicCode
```

可以使用相同命令禁用审核模式，但将 替换为 `-Enable` `-Disable`。

### <a name="powershell-reference-table"></a>PowerShell 参考表

下表列出了可用于配置 (缓解的 PowerShell cmdlet) 关联的审核模式 cmdlet。

<a id="cmdlets-table"></a>

|缓解|适用对象|PowerShell cmdlet|审核模式 cmdlet|
|---|---|---|---|
|控制流保护 (CFG) |系统和应用级别|CFG、StrictCFG、SuppressExports|审核不可用|
|数据执行保护(DEP)|系统和应用级别|DEP、EmulateAtlThunks|审核不可用|
|强制图像随机化(强制 ASLR)|系统和应用级别|ForceRelocateImages|审核不可用|
|随机内存分配(由下而上 ASLR)|系统和应用级别|BottomUp、HighEntropy|审核不可用|
|验证异常链(SEHOP)|系统和应用级别|SEHOP、SEHOPTelemetry|审核不可用|
|验证堆完整性|系统和应用级别|TerminateOnError|审核不可用|
|任意代码防护(ACG)|仅应用级别|DynamicCode|AuditDynamicCode|
|阻止低完整性图像|仅应用级别|BlockLowLabel|AuditImageLoad|
|阻止远程图像|仅应用级别|BlockRemoteImages|审核不可用|
|阻止不受信任的字体|仅应用级别|DisableNonSystemFonts|AuditFont、FontAuditOnly|
|代码完整性防护|仅应用级别|BlockNonMicrosoftSigned、AllowStoreSigned|AuditMicrosoftSigned、AuditStoreSigned|
|禁用扩展点|仅应用级别|ExtensionPoint|审核不可用|
|禁用 Win32k 系统调用|仅应用级别|DisableWin32kSystemCalls|AuditSystemCall|
|不允许子进程|仅应用级别|DisallowChildProcessCreation|AuditChildProcess|
|导出地址筛选(EAF)|仅应用级别|EnableExportAddressFilterPlus、EnableExportAddressFilter <a href="#r1" id="t1">\[1\]</a>|审核不可用<a href="#r2" id="t2">\[2\]</a>|
|导入地址筛选(IAF)|仅应用级别|EnableImportAddressFilter|审核不可用<a href="#r2" id="t2">\[2\]</a>|
|模拟执行(SimExec)|仅应用级别|EnableRopSimExec|审核不可用<a href="#r2" id="t2">\[2\]</a>|
|验证 API 调用(CallerCheck)|仅应用级别|EnableRopCallerCheck|审核不可用<a href="#r2" id="t2">\[2\]</a>|
|验证处理使用情况|仅应用级别|StrictHandle|审核不可用|
|验证映像依赖项完整性|仅应用级别|EnforceModuleDepencySigning|审核不可用|
|验证堆栈完整性(StackPivot)|仅应用级别|EnableRopStackPivot|审核不可用<a href="#r2" id="t2">\[2\]</a>|

<a href="#t1" id="r1">\[1\]</a>：使用以下格式为进程启用 dll 的 EAF 模块：

```PowerShell
Set-ProcessMitigation -Name processName.exe -Enable EnableExportAddressFilterPlus -EAFModules dllName1.dll,dllName2.dll
```

<a href="#t2" id="r2">\[2\]</a>：无法通过 PowerShell cmdlet 审核此缓解。

## <a name="customize-the-notification"></a>自定义通知

有关在触发规则并阻止应用或文件时自定义通知[Windows 安全中心。](/windows/security/threat-protection/windows-defender-security-center/windows-defender-security-center)

## <a name="see-also"></a>另请参阅

- [保护设备免遭攻击](exploit-protection.md)
- [评估 Exploit Protection](evaluate-exploit-protection.md)
- [启用漏洞保护](enable-exploit-protection.md)
- [导入、导出和部署 Exploit Protection 配置](import-export-exploit-protection-emet-xml.md)
